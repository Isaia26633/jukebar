<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Player</title>
    <link rel="stylesheet" href="../styles/sp.css">
</head>

<body id="colorContent">
    <%- include("partials/header.ejs") %>

        <div id="content" class="contentBox">
            <h1>Spotify Player</h1>
            <div id="search">
                <p>Search for a song to play:</p>
                <input type="text" id="searchBar" placeholder="Search for a song">
                <button type="submit" class="searchButton" onclick="search()">Search</button>

                <div id="searchResults">
                    search results
                </div>

                <button onclick="addSong()">Add to Queue</button>
            </div>

            <div id="queue">
                <h2>Queue</h2>
                <div id="current">
                    <iframe id="playerFrame" src="https://open.spotify.com/embed/track/3n3Ppam7vgaVa1iaRUc9Lp"
                        width="300" height="380" allowtransparency="true" frameborder="0"
                        allow="encrypted-media"></iframe>
                    <div id="playerControls">
                        <button id="play">Play</button>
                        <button id="pause">Pause</button>
                        <button id="next">Next</button>
                        <button id="previous">Previous</button>
                        <div id="volume">
                            <input type="range" id="volumeControl" min="0" max="100" value="100">
                        </div>
                    </div>
                </div>
                <div id="next">
                    <ol>
                        <li>Next song</li>
                        <li>Next song</li>
                        <li>Next song</li>
                        <li>Next song</li>
                        <li>Next song</li>
                    </ol>
                </div>
            </div>

            <%- include("partials/footer.ejs") %>

                <script>
                    const searchBar = document.getElementById("searchBar");
                    const searchResults = document.getElementById("searchResults");

                    var queue = [];

                    function search() {
                        const query = document.getElementById('searchBar').value;
                        if (!query) return alert("Please enter a song name.");

                        fetch(`/search?q=${encodeURIComponent(query)}`)
                            .then(response => response.json())
                            .then(data => {
                                const resultsDiv = document.getElementById('current');

                                if (data.error) {
                                    resultsDiv.innerHTML = `<p>Error: ${data.error}</p>`;
                                } else {
                                    resultsDiv.innerHTML = `
                                <h3>${data.name}</h3>
                                <p>Artist: ${data.artist}</p>
                                <button onclick="playSong('${data.uri}')" class='playback'>Play</button>
                                <br>
                                <button onclick="addToQueue('${data.uri}')">Add to Queue</button>
                            `;
                                    console.log(data.uri)
                                }
                            })
                            .catch(err => {
                                console.error('Fetch Error:', err); // Log any fetch errors
                                document.getElementById('current').innerHTML = "An error occurred while searching.";
                            });
                    }

                    function addSong() {
                        queue.push(searchResults);
                        searchResults.innerHTML = "";
                    }

                    function playSong(uri) {
                        console.log("Attempting to play song with URI:", uri); // Debug log
                        
                        fetch('/play', {
                            method: "POST",
                            headers: { 
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({ uri: uri })
                        })
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(err => Promise.reject(err));
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                alert("Playing song: " + data.trackInfo.name);
                            } else {
                                alert("Error: " + (data.error || "Unknown error"));
                            }
                        })
                        .catch(err => {
                            console.error('Fetch Error:', err);
                            alert("Failed to play song: " + (err.error || err.message || "Unknown error"));
                        });
                    }

                    function addToQueue(uri) {
                        queue.push(uri);
                        alert("Song added to queue!");
                    }

                </script>
</body>

</html>
